@using FoodAdvisor.ViewModels.UserViewModels
@using Microsoft.EntityFrameworkCore
@model IEnumerable<IndexAllUsersViewModel>

@{
	ViewData["Title"] = "Admin Panel";
}

@inject RoleManager<IdentityRole<Guid>> roleManager
<link rel="stylesheet" href="~/css/Admin/admin-manage.css" asp-append-version="true" />

@{
	IEnumerable<string?> allRoles = await roleManager.Roles
		.Select(r => r.Name)
		.ToArrayAsync();
}


<h2>Admin Panel</h2>

<div class="search-container">
	<input type="text" placeholder="Search users..." id="searchBox" oninput="filterUsers()" />
</div>

<table class="admin-table">
	<thead>
		<tr>
			<th>User</th>
			<th>Email</th>
			<th>Current Role</th>
			<th>Is Manager</th>
			<th>Add Role</th>
			<th>Remove Role</th>
			<th>Make Manager</th>
			<th>Delete User</th>
		</tr>
	</thead>
	<tbody id="userTable">
		@foreach (var user in Model)
		{
			<tr>
				<td>@user.Username</td>
				<td>@user.Email</td>
				<td>
					@foreach (var role in user.CurrentRoles)
					{
						<span class="badge bg-secondary">@role</span>
					}
				</td>
				<td>@user.IsManager</td>
				<td>
					<form method="post" asp-action="UpdateRole" asp-controller="AdminManage" asp-area="Admin" class="role-form">
						<select name="roleName" class="role-dropdown">
							@foreach (var role in allRoles)
							{
								<option value="@role">@role</option>
							}
						</select>
						<input type="hidden" name="userId" value="@user.Id" />
						<button type="submit" class="role-update-button">✔</button>
					</form>
				</td>
				<td>
					<form method="post" asp-action="RemoveRole" asp-controller="AdminManage" asp-area="Admin" class="role-form">
						<select name="roleName" class="role-dropdown">
							@foreach (var role in user.CurrentRoles)
							{
								<option value="@role">@role</option>
							}
						</select>
						<input type="hidden" name="userId" value="@user.Id" />
						<button type="submit" class="delete-button">❌</button>
					</form>
				</td>
				<td>
						@if (user.IsManager == false)
						{
						<form method="post" asp-action="MakeManager" asp-controller="AdminManage" asp-area="Admin" class="role-form">
							<input type="hidden" name="userId" value="@user.Id" />
							<button type="submit" class="role-update-button">✔Make Manager</button>
						</form>
						}
						else if (user.IsManager == true)
						{
						<form method="post" asp-action="RemoveManager" asp-controller="AdminManage" asp-area="Admin" class="role-form">
							<input type="hidden" name="userId" value="@user.Id" />
							<button type="submit" class="delete-button">❌Remove Manager</button>
						</form>
						}
				</td>
				<td>
					<form method="post" asp-action="Delete" asp-controller="AdminManage" asp-area="Admin" class="delete-form">
						<input type="hidden" name="userId" value="@user.Id" />
						<button type="submit" class="delete-button">🗑 Delete User</button>
					</form>
				</td>
			</tr>
		}
	</tbody>
</table>

@section Scripts {
	<script>
		function filterUsers() {
			const searchValue = document.getElementById('searchBox').value.toLowerCase();
			const rows = document.querySelectorAll('#userTable tr');
			rows.forEach(row => {
				const username = row.cells[0].textContent.toLowerCase();
				const email = row.cells[1].textContent.toLowerCase();
				row.style.display = (username.includes(searchValue) || email.includes(searchValue)) ? '' : 'none';
			});
		}
	</script>
}

